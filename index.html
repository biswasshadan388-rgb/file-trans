<!DOCTYPE html>
<html>
<head>
  <title>Big File Transfer</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea { width: 100%; height: 100px; }
    #log { white-space: pre; background: #eee; padding: 10px; height: 150px; overflow: auto; }
  </style>
</head>
<body>

<h2>Big File Transfer (Simple Peer to Peer)</h2>

<input type="file" id="fileInput"><br><br>

<button id="createOffer">Send File</button>
<button id="createAnswer">Receive File</button>

<h3>Copy This Offer/Answer</h3>
<textarea id="offer"></textarea><br><br>
<textarea id="answer"></textarea><br><br>

<div id="log"></div>

<script>
let pc = new RTCPeerConnection();
let channel;
let fileReader;
let file;
let fileSize = 0;
let receivedBuffer = [];
let receivedSize = 0;

function log(msg){ 
  document.getElementById("log").textContent += msg + "\n";
}

pc.ondatachannel = event => {
  channel = event.channel;
  setupReceiver();
};

function setupReceiver(){
  channel.onmessage = e => {
    receivedBuffer.push(e.data);
    receivedSize += e.data.byteLength;
    log("Received: " + receivedSize + " bytes");

    if(receivedSize === fileSize){
      let received = new Blob(receivedBuffer);
      let a = document.createElement("a");
      a.href = URL.createObjectURL(received);
      a.download = "received_file";
      a.click();
      log("Download ready!");
    }
  };
}

document.getElementById("createOffer").onclick = async () => {
  file = document.getElementById("fileInput").files[0];
  fileSize = file.size;

  channel = pc.createDataChannel("file");
  setupSender();

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  document.getElementById("offer").value = JSON.stringify(offer);
};

function setupSender(){
  channel.onopen = () => {
    log("Connection open. Sending file...");
    sendFile();
  };
}

async function sendFile(){
  const chunkSize = 64 * 1024;
  let offset = 0;

  fileReader = new FileReader();
  fileReader.onload = e => {
    channel.send(e.target.result);
    offset += e.target.result.byteLength;
    log("Sent: " + offset + " bytes");

    if(offset < file.size){
      readSlice(offset);
    }
  };

  const readSlice = o => {
    const slice = file.slice(o, o + chunkSize);
    fileReader.readAsArrayBuffer(slice);
  };

  readSlice(0);
}

document.getElementById("createAnswer").onclick = async () => {
  let offer = JSON.parse(document.getElementById("offer").value);
  await pc.setRemoteDescription(offer);

  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  document.getElementById("answer").value = JSON.stringify(answer);
};

document.getElementById("answer").addEventListener("input", async () => {
  let answer = JSON.parse(document.getElementById("answer").value);
  await pc.setRemoteDescription(answer);
});
</script>

</body>
</html>
